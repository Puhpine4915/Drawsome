@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lobby</title>
    <link rel="stylesheet" href="~/css/style.css" />
    <script src="~/js/signalR.js"></script>
</head>
<body>
<div class="login-container">
    <h2>Welcome to Drawsome!</h2>
    <p>You're logged in as @Context.Session.GetString("Username")!</p>
    <div id="errorMessage" style="display: none;"></div>
    <div>
        <input type="text" id="createLobbyName" placeholder="Lobby Name" />
        <button onclick="createLobby()">Create Lobby</button>
    </div>
    <div>
        <input type="text" id="joinLobbyName" placeholder="Lobby Name" />
        <button onclick="joinLobby()">Join Lobby</button>
    </div>
    <div id="lobbyDetails" style="display: none;">
        <h3 id="lobbyName"></h3>
        <h3>Players:</h3>
        <ul id="playerList"></ul>
    </div>
</div>
<script>
    let connection;

    const startConnection = async () => {
        connection = new signalR.HubConnectionBuilder()
            .withUrl("/lobbyHub")
            .build();

        try {
            await connection.start();
            console.log("SignalR Connected.");
        } catch (err) {
            console.error(err.toString());
        }

        connection.on("UpdatePlayers", (players) => {
            const playerList = document.getElementById("playerList");
            playerList.innerHTML = "";
            players.forEach(player => {
                const li = document.createElement("li");
                li.textContent = player;
                playerList.appendChild(li);
            });
            document.getElementById("errorMessage").style.display = "none";
        });

        connection.on("LobbyNotFound", (lobbyName) => {
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = `Error: Lobby "${lobbyName}" not found!`;
            errorMessage.style.color = "red";
            errorMessage.style.display = "block";
            document.getElementById("lobbyDetails").style.display = "none";
        });

        connection.on("LobbyCreationFailed", (lobbyName) => {
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = `Error: Lobby "${lobbyName}" already exists!`;
            errorMessage.style.color = "red";
            errorMessage.style.display = "block";
            document.getElementById("lobbyDetails").style.display = "none";
        });
    }

    startConnection();

    function createLobby() {
        if (connection) {
            const lobbyName = document.getElementById("createLobbyName").value;
            const username = "@Context.Session.GetString("Username")";
            connection.invoke("CreateLobby", lobbyName, username)
                .then((result) => {
                    if (result) {
                        document.getElementById("lobbyDetails").style.display = "block";
                        document.getElementById("lobbyName").textContent = "Lobby: " + lobbyName;
                    }
                })
                .catch(err => console.error(err.toString()));
        } else {
            console.error("SignalR connection not established.");
        }
    }


    function joinLobby() {
        if (connection) {
            const lobbyName = document.getElementById("joinLobbyName").value;
            const username = "@Context.Session.GetString("Username")";
            connection.invoke("JoinLobby", lobbyName, username).catch(err => console.error(err.toString()));
        } else {
            console.error("SignalR connection not established.");
        }
    }

    window.addEventListener('beforeunload', function (e) {
        if(connection){
            const lobbyName = document.getElementById("joinLobbyName").value || document.getElementById("createLobbyName").value;
            const username = "@Context.Session.GetString("Username")";
            if (lobbyName) {
                connection.invoke("LeaveLobby", lobbyName, username).catch(err => console.error(err.toString()));
            }
        }
    });
</script>
</body>
</html>